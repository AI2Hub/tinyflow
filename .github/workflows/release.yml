name: Release and Publish to NPM

on:
  push:
    branches:
      - main # 或者你的主分支名称
      - develop # 如果有开发分支
  workflow_dispatch: # 允许手动触发工作流

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # 获取完整的 Git 历史记录，Changesets 需要它来生成变更日志

      # 2. 设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20 # 指定 Node.js 20 或更高版本
          registry-url: https://registry.npmjs.org/ # 设置 NPM 注册表

      # 3. 安装 pnpm
      - name: Install pnpm
        run: npm install -g pnpm

      # 4. 安装依赖
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      # 5. 设置 Git 用户信息
      - name: Set Git User Info
        run: |
          git config --global user.name "Michael"
          git config --global user.email "fuhai999@gmail.com"

      # 6. 检查是否有待发布的变更集
      - name: Check for changesets
        id: check_changesets
        run: |
          if [ -z "$(ls -A .changeset)" ]; then
            echo "No changesets found, skipping publish."
            echo "has_changesets=false" >> $GITHUB_ENV
          else
            echo "Changesets found, proceeding with publish."
            echo "has_changesets=true" >> $GITHUB_ENV
          fi

      # 7. 使用 Changesets Action 自动化发布
      - name: Create Release PR or publish stable version to npm
        if: env.has_changesets == 'true'
        id: changesets
        uses: changesets/action@v1
        with:
          createGithubReleases: false
          publish: pnpm changeset publish
          version: pnpm changeset version
          title: ${{ github.ref_name == 'main' && 'Publish a new stable version' || 'Publish a new pre-release version' }}
          commit: >-
            ${{ github.ref_name == 'main' && 'chore(release): publish a new release version' || 'chore(release): publish a new pre-release version' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

name: Release and Publish to NPM

on:
  push:
    branches:
      - main # 或者你的主分支名称
  workflow_dispatch: # 允许手动触发工作流

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # 获取完整的 Git 历史记录，Changesets 需要它来生成变更日志

      # 2. 设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20 # 指定 Node.js 20 或更高版本
          registry-url: https://registry.npmjs.org/ # 设置 NPM 注册表

      # 3. 安装 pnpm
      - name: Install pnpm
        run: npm install -g pnpm

      # 4. 安装依赖
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      # 5. 设置 NPM 认证令牌
      - name: Configure NPM Token
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc

      # 6. 运行 Changesets 版本更新
      - name: Run Changesets Version
        run: pnpm changeset version

      # 7. 提交版本更新和变更日志
      - name: Commit Version Updates
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          git diff --staged --quiet || git commit -m "chore: update versions and changelog [skip ci]"

      # 8. 发布到 NPM
      - name: Publish to NPM
        run: pnpm changeset publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # 9. 推送版本更新到 GitHub 仓库
      - name: Push Changes to GitHub
        run: |
          git push origin main
          git push origin --tags
